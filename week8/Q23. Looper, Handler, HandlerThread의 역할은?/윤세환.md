### Message Queue

- Handler가 보낸 Message 객체들을 큐 구조로 저장하는 대기열
- Handler가 post, sendMessage를 호출하면 해당 Message는 MessageQueue에 저장되며, 이를 Looper에서 감지

### Message

- Thread간 상호작용을 위해 전달되는 객체로, 내부적으로 target 이라는 변수에 어떤 핸들러에서 이 작업을 수행하는지를 명시한다.

---

### Looper

- MessageQueue를 감시
- 들어온 Message를 분석하여 해당 Message를 적합한 Handler에서 처리할 수 있도록 함
    - Message 객체 내 target 변수에 할당된 Handler 객체의 dispatchMessage를 호출
- Thread에 0개 또는 1개 존재할 수 있으며, looper가 없는 경우 다른 thread와의 상호작용이 이루어질 수 없다.
- https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/core/java/android/os/Looper.java

### Handler

- Message를 전송하고, 처리하는 작업을 수행
- 생성시 인자로 전달된 Looper에 연결되며, 이 Handler가 메세지를 처리할 때는 항상 Looper가 실행되는 Thread에서 코드가 실행됨
- handler.post 같은 메서드를 통해 looper로 Message를 전달한다.
    - 내부적으로는 post의 body 부분(Runnable)을 Message 객체로 래핑함과 동시에, 해당 Message 객체의 target 변수를 자기 자신(Handler)로 설정한 후 이 Message를 looper의 thread내 messageQueue로 전달한다.
- https://android.googlesource.com/platform/frameworks/base/+/HEAD/core/java/android/os/Handler.java

```kotlin
val handler = Handler(Looper.getMainLooper())

handler.post {
 // looper와 연결된 Thread에서 수행할 작업
}
```

### HandlerThread

- 내장된 Looper를 가지는 Thread
- getLooper를 사용하여 해당 thread의 looper를 가져올 수 있으며, 리소스를 해제하려면 항상 quit() 또는 quitSafely()를 호출해야 한다.
- https://android.googlesource.com/platform/frameworks/base/+/refs/heads/main/core/java/android/os/HandlerThread.java?hl=ja%2F

### Q. Handler는 Looper와 어떻게 상호작용하여 스레드 간 통신을 용이하게 하며, Handler와 일반적인 사용 사례를 말씀해주세요.

1. Handler를 생성할 때 상호작용하고자 하는 thread의 looper를 가져와 Handler 생성자에 전달한다.
2. Handler의 post 또는 sendMessage 메서드를 사용하여 상호작용하고자 하는 thread의 messageQueue에 Message를 전달한다.
3. 해당 thread의 looper가 messageQueue를 감시하여 들어온 Message를 가져온 후, 해당 Message의 target (=handler)가 해당 작업을 looper의 thread에서 실행하도록 한다.
- 이는 coroutine이 사용되기 전 고전적인 네트워크 작업 후 UI를 수정하는 것과 같은 경우에 사용된다.

### Q. HandlerThread란 무엇이며, Looper.prepare()를 사용하여 수동으로 스레드를 생성하는 것과 비교하여 백그라운드 스레드 관리를 어떻게 단순화하나요?

- HandlerThread의 경우 생성 시점부터 자체적인 Looper를 가지는 thread를 의미한다.
- 기존에는 Thread의 run 메서드 내부에서 Looper.prepare()를 통해 Looper를 thread에 바인딩한 후, looper.loop를 호출하여 thread의 messageQueue 관찰을 명시적으로 선언해 한다.
- 반면 HandlerThread의 경우 이와 관련된 작업이 필요없음과 동시에 looper를 통해 해당 HandlerThread의 looper를 쉽게 가져올 수 있다.